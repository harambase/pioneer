<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:include="/common :: header('课程查询',true, true)"></head>
<body>
<div id="wrapper">
    <!--/. NAV TOP  -->
    <div th:include="/common :: navtop" class="sidebar-collapse"></div>

    <!-- /. NAV SIDE  -->
    <div th:include="/common :: navbar" class="sidebar-collapse"></div>
    <div id="page-wrapper">
        <div class="header">
            <h1 class="page-header">
                先锋教学系统
                <small>课程查询</small>
            </h1>
            <ol class="breadcrumb">
                <li><a href="/index">主页</a></li>
                <li><a href="#">教学系统</a></li>
                <li class="active">课程查询</li>
            </ol>

        </div>
        <div id="page-inner">
            <div class="row">
                <div class="col-md-12">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            搜索条件
                        </div>
                        <div class="panel-body">
                            <div class="form-group">
                                <div class="col-sm-2">
                                    <label class="col-sm-12 control-label">*按学期查询:</label>
                                </div>
                                <div class="col-sm-3">
                                    <select class="js-example-basic-single info col-sm-12"></select>
                                </div>
                                <div class="col-sm-2">
                                    <label class="col-sm-12 control-label">*按授课老师查询:</label>
                                </div>
                                <div class="col-sm-3">
                                    <select class="js-example-basic-single user col-sm-12"></select>
                                </div>
                                <div class="col-sm-2">
                                    <button class="btn btn-primary col-sm-12" onclick="refresh()">查询</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-12">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            课程列表
                        </div>
                        <div class="panel-body">
                            <table class="table table-striped table-bordered table-hover" id="courseTable"></table>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <!-- /. PAGE INNER  -->
        <div class="panel-footer" id=footerPlaceholder">
            <div th:include="/common :: footer" id="copyright"></div>
        </div>
    </div>

    <!-- /. PAGE WRAPPER  -->
</div>
<!-- /. WRAPPER  -->
<div th:include="/common :: load_js(true, false, true)"></div>

<script>
    function refresh() {
        courseTable.draw();
    }

    $(".info").select2({
        ajax: {
            url: basePath + "/course/info",
            type: "GET",
            delay: 250,
            data: function (params) {
                return {
                    search: params.term,
                };
            },
            processResults: function (data) {
                let itemList = [];
                let item;
                for (let i = 0; i < data.data.length; i++) {
                    item = {
                        id: data.data[i],
                        text: data.data[i]
                    };
                    itemList.push(item);
                }
                item = {
                    id: "",
                    text: "清除"
                };
                itemList.push(item);
                return {
                    results: itemList
                };
            },
            cache: true
        },
        language: "zh-CN",
        tags: false,//允许手动添加
        allowClear: true,//允许清空
        escapeMarkup: function (markup) {
            return markup;
        }, // 自定义格式化防止xss注入
        minimumInputLength: 0,
        templateResult: formatRepo,
        templateSelection: formatRepoSelection
    });

    $(".user").select2({
        ajax: {
            url: basePath + "/user/search",
            type: "GET",
            delay: 250,
            data: function (params) {
                return {
                    search: params.term,
                    status: "1",
                    type: "f"
                };
            },
            processResults: function (data) {
                let itemList = [];
                let item;
                for (let i = 0; i < data.data.length; i++) {
                    item = {
                        id: data.data[i].userId,
                        text: data.data[i].lastName + ", " + data.data[i].firstName
                    };
                    itemList.push(item);
                }
                return {
                    results: itemList
                };
            },
            cache: true
        },
        language: "zh-CN",
        tags: false,//允许手动添加
        allowClear: false,//允许清空
        escapeMarkup: function (markup) {
            return markup;
        }, // 自定义格式化防止xss注入
        minimumInputLength: 0,
        templateResult: formatRepo,
        templateSelection: formatRepoSelection
    });

    let courseTable = $("#courseTable").DataTable({

        "language": {
            "aria": {
                "sortAscending": ": activate to sort column ascending",
                "sortDescending": ": activate to sort column descending"
            },
            "emptyTable": "没有数据！",
            "info": "显示 _START_ 至 _END_ 条 ，总共_TOTAL_ 条数据",
            "infoEmpty": "没有发现记录！",
            "infoFiltered": "(从_MAX_条记录中搜索)",
            "lengthMenu": "显示: _MENU_",
            "search": "模糊搜索:",
            "zeroRecords": "没有找到匹配的记录！",
            "paginate": {
                "previous": "上一页",
                "next": "下一页",
                "last": "尾页",
                "first": "首页"
            }
        },
        "pagingType": "full_numbers",
        "lengthMenu": [
            [5, 10, 15, 20],
            [5, 10, 15, 20]
        ],
        pageLength: 10,
        processing: true,
        serverSide: true,

        ajax: {
            url: basePath + "/course",
            data: function (d) {
                d.mode = "student";
                d.info = $(".info").val();
                d.facultyId = $(".user").val();
            }
        },
        columns: [
            {
                "data": null, "title": "行号", "render": function (data, type, row, meta) {
                    return meta.settings._iDisplayStart + meta.row + 1;
                }
            },
            {"data": "crn", "title": "编号"},
            {
                "data": null, "title": "课程名（等级-班级）", "createdCell": function (nTd, rowData) {
                    $(nTd).html('<p style="line-height: 1.42857143; padding-top: 0; color:blue; ">' + rowData.name + " (" + rowData.level + "-" + rowData.section + ")" + '</p>');
                }
            },
            {"data": "capacity", "title": "容量"},
            {"data": "remain", "title": "剩余"},
            {
                "data": "status", "title": "状态", "createdCell": function (nTd, rowData) {
                    if (rowData === 1)
                        $(nTd).html('<p style="line-height: 1.42857143; padding-top: 0; color:blue; ">未开始</p>');
                    else if (rowData === 0)
                        $(nTd).html('<p style="line-height: 1.42857143; padding-top: 0; color:green; ">进行中</p>');
                    else if (rowData === -1)
                        $(nTd).html('<p style="line-height: 1.42857143; padding-top: 0; color:red; ">已结课</p>');

                }
            },
            {"data": "date", "title": "起止时间"},
            {"data": "time", "title": "上课时间"},
            {"data": "day", "title": "星期"},
            {"data": "faculty", "title": "授课老师"},
        ],
        "columnDefs": [{
            "defaultContent": "",
            "targets": "_all"
        }]
    });
</script>

</body>
</html>
