<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:v-on="http://www.w3.org/1999/xhtml">

<head th:include="/common :: header('辅导管理', true, true)"></head>
<body>
<div id="wrapper">
    <!--/. NAV TOP  -->
    <div th:include="/common :: navtop" class="sidebar-collapse"></div>

    <!-- /. NAV SIDE  -->
    <div th:include="/common :: navbar" class="sidebar-collapse"></div>

    <div id="page-wrapper">
        <div class="header">
            <h1 class="page-header">
                先锋教务管理
                <small>辅导管理</small>
            </h1>
            <ol class="breadcrumb">
                <li><a href="/index">主页</a></li>
                <li><a href="#">教务管理</a></li>
                <li class="active">辅导管理</li>
            </ol>

        </div>
        <div id="page-inner">
            <div class="row" id="advisePage">
                <div class="col-md-12">
                    <div class="panel panel-default" style="border: 0px; background: rgba(255, 255, 255, 0);">
                        <button id="addNew" class="btn btn-success" data-dismiss="modal" aria-label="Close">
                            <i class="fa fa-plus-square" aria-hidden="true"></i> 添加新的辅导关系
                        </button>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            辅导关系列表
                        </div>
                        <div class="panel-body">
                            <table style="width: 100%" class="table table-striped table-bordered table-hover"
                                   id="adviseTable"></table>
                        </div>
                    </div>
                </div>
            </div>
            <div id="addAdvise" class="modal fade modalDiy" tabindex="-1" role="dialog">
                <div class="modal-dialog modal-md" role="document">
                    <div class="panel panel-success" style="background: rgba(255, 255, 255, 1);">
                        <div class="panel-heading">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                    aria-hidden="true">&times;</span>
                            </button>
                            <h4 class="modal-title">添加新的辅导关系</h4>
                        </div>
                        <div class="panel-body">
                            <form id="addAdviseForm" class="form-group" method="post" onsubmit="return false">
                                <div class="col-sm-3">
                                    <label class="col-sm-12 control-label">*请选择学生:</label>
                                </div>
                                <div class="col-sm-9">
                                    <select style="width: 100%" class="js-example-basic-single student" name="student">
                                    </select>
                                </div>
                                <div class="col-sm-3" style="margin-top:10px;">
                                    <label class="col-sm-12 control-label">*请选择教师:</label>
                                </div>
                                <div class="col-sm-9" style="margin-top:10px;">
                                    <select style="width: 100%" class="js-example-basic-single faculty" name="faculty">
                                    </select>
                                </div>
                                <div class="col-sm-3" style="margin-top:10px;">
                                    <label for="tPassword" class="col-sm-12 control-label">*操作密码:</label>
                                </div>
                                <div class="col-sm-9" style="margin-top:10px;">
                                    <input type="password" id="tPassword" class="form-control" minlength="6"
                                           maxlength="16" checkOpPwd="true" required/>
                                </div>
                                <div class="col-sm-6" style="margin-top:10px;">
                                    <button class="btn btn-danger btn-primary col-sm-12" v-on:click="add">确认添加
                                    </button>
                                </div>
                                <div class="col-sm-6" style="margin-top:10px;">
                                    <button id="cancel" style="width: 100%" class="btn btn-info btn-primary"
                                            data-dismiss="modal" aria-label="Close">取消
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="panel-footer" id=footerPlaceholder">
            <div th:include="/common :: footer" id="copyright"></div>
        </div>
        <!-- /. PAGE INNER  -->
    </div>
    <!-- /. PAGE WRAPPER  -->
</div>
<!-- /. WRAPPER  -->
<div th:include="/common :: load_js(true, false ,true)"></div>
<script>
    //添加关系
    $("#addNew").click(function () {
        $("#searchFValue").empty();
        $("#searchSValue").empty();
        $("#addAdvise").modal('show');
    });

    let adviseVue = new Vue({
        el: "#advisePage",
        data: {
            advise: {
                id: "",
                status: "",
                studentId: "",
                facultyId: "",
                updateTime: "",
                operatorId: ""
            }
        },
        methods:{
            add: function () {
                this.advise.studentId = $(".student").val();
                this.advise.facultyId = $(".faculty").val();
                this.advise.status = 1;
                axios.post('/advise', this.advise).then(function(reponse){
                    if (reponse.data.code === 2001)
                        Showbo.Msg.alert("创建成功!", function () {
                            adviseTable.draw();
                            $("#addAdvise").modal('hide');
                        });
                    else
                        Showbo.Msg.alert(reponse.data.msg, function () {
                        });

                });
            }
        }
    });

    //更新状态
    function updateStatus(id, status) {
        adviseVue.$data.advise.status = status;
        axios.put('/advise/' + id, adviseVue.$data.advise).then(function(reponse){
                if (reponse.data.code === 2001)
                    Showbo.Msg.alert("更新成功!", function () {
                        adviseTable.draw();
                    });
                else
                    Showbo.Msg.alert(reponse.data.msg, function () {
                    });

        });
    }

    //移除关系
    function deleteAdvise(id) {
        Showbo.Msg.confirm("确认删除该关系？", function () {
            if ($(".btnfocus").val() !== "取消") {
                /*删除操作*/
                $.ajax({
                    url: basePath + "/admin/advise/remove?id=" + id,
                    type: "DELETE",
                    contentType: "application/json; charset=utf-8",
                    success: function (data) {
                        if (data.code === 2001)
                            Showbo.Msg.alert("删除成功!", function () {
                                adviseTable.draw();
                            });
                        else
                            Showbo.Msg.alert(data.msg, function () {
                            });
                    }
                });
            }
        });
    }

    let fSelect = $(".faculty").select2({
        ajax: {
            url: basePath + "/user/search",
            type: "GET",
            delay: 250,
            data: function (params) {
                return {
                    search: params.term, // search term 请求参数 ， 请求框中输入的参数
                    status: "1",
                    type: "f"
                };
            },
            processResults: function (data, params) {
                let itemList = [];
                let item;
                for (let i = 0; i < data.data.length; i++) {
                    item = {
                        id: data.data[i].userId,
                        text: data.data[i].lastName + ", " + data.data[i].firstName
                    };
                    itemList.push(item);
                }
                return {
                    results: itemList//itemList
                };
            },
            cache: true
        },
        language: "zh-CN",
        tags: false,//允许手动添加
        allowClear: true,//允许清空
        escapeMarkup: function (markup) {
            return markup;
        }, // 自定义格式化防止xss注入
        minimumInputLength: 0,//最少输入多少个字符后开始查询
        templateResult: formatRepo,
        templateSelection: formatRepoSelection
    });

    let sSelect = $(".student").select2({
        ajax: {
            url: basePath + "/user/search",
            type: "GET",
            delay: 250,
            data: function (params) {
                return {
                    search: params.term, // search term 请求参数 ， 请求框中输入的参数
                    status: "1",
                    type: "s"
                };
            },
            processResults: function (data, params) {
                let itemList = [];
                let item;
                for (let i = 0; i < data.data.length; i++) {
                    item = {
                        id: data.data[i].userId,
                        text: data.data[i].lastName + ", " + data.data[i].firstName
                    };
                    itemList.push(item);
                }
                return {
                    results: itemList//itemList
                };
            },
            cache: true
        },
        language: "zh-CN",
        tags: false,//允许手动添加
        allowClear: true,//允许清空
        escapeMarkup: function (markup) {
            return markup;
        }, // 自定义格式化防止xss注入
        minimumInputLength: 0,//最少输入多少个字符后开始查询
        templateResult: formatRepo,
        templateSelection: formatRepoSelection
    });

    let adviseTable = $("#adviseTable").DataTable({

        "language": {
            "aria": {
                "sortAscending": ": activate to sort column ascending",
                "sortDescending": ": activate to sort column descending"
            },
            "emptyTable": "没有数据！",
            "info": "显示 _START_ 至 _END_ 条 ，总共_TOTAL_ 条数据",
            "infoEmpty": "没有发现记录！",
            "infoFiltered": "(从_MAX_条记录中搜索)",
            "lengthMenu": "显示: _MENU_",
            "search": "搜索:",
            "zeroRecords": "没有找到匹配的记录！",
            "paginate": {
                "previous": "上一页",
                "next": "下一页",
                "last": "尾页",
                "first": "首页"
            }
        },
        "lengthMenu": [
            [10, 20, 50],
            [10, 20, 50]
        ],
        pageLength: 10,
        processing: true,
        serverSide: true,

        ajax: {
            url: basePath + "/admin/advise/list",
            data: function (d) {
                d.studentid = null;
                d.facultyid = null;
            }
        },
        columns: [
            {"data": "sname", "title": "学生姓名"},
            {"data": "fname", "title": "教师姓名"},
            {
                "data": "status", "title": "状态", "createdCell": function (nTd, rowData) {
                if (rowData === "1")
                    $(nTd).html('<p style="line-height: 1.42857143; padding-top: 0; color:green; ">正常</p>');
                else if (rowData === "0")
                    $(nTd).html('<p style="line-height: 1.42857143; padding-top: 0; color:red; ">已停止</p>');
            }
            },
            {"data": "updateTime", "title": "更新时间"},
            {"data": "oname", "title": "操作人"},
            {
                "data": null, "title": "操作", "createdCell": function (nTd, rowData) {
                let htmlStr = '<button class="btn btn-info" style="width:50%" onclick="deleteAdvise(\'' + rowData.id + '\')">删除辅导关系</button>';
                if (rowData.status === "0")
                    htmlStr += '<button class="btn btn-success" style="width:50%" onclick="updateStatus(\'' + rowData.id + '\',\'' + "1" + '\')">启用辅导关系</button>';
                else
                    htmlStr += '<button class="btn btn-danger " style="width:50%" onclick="updateStatus(\'' + rowData.id + '\',\'' + "0" + '\')">停止辅导关系</button>';
                $(nTd).html(htmlStr);

            }, "width": "200px"
            }
        ],
        "columnDefs": [{
            orderable: false,
            targets: [5]
        }, {
            "defaultContent": "",
            "targets": "_all"
        }]
    });
</script>

<!--<script src="/static/scripts/advise.js"></script>-->
</body>
</html>
