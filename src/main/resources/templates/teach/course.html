<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/xhtml" xmlns:v-on="http://www.w3.org/1999/xhtml"
>

<head th:include="/common :: header('课程管理',true, true)"></head>
<body>
<div id="wrapper">
    <!--/. NAV TOP  -->
    <div th:include="/common :: navtop" class="sidebar-collapse"></div>

    <!-- /. NAV SIDE  -->
    <div th:include="/common :: navbar" class="sidebar-collapse"></div>

    <div id="page-wrapper">
        <div id="coursePage">
            <div class="header" v-if="url.indexOf('teach') !== -1">
                <h1 class="page-header">
                    先锋教务管理
                    <small>课程管理</small>
                </h1>
                <ol class="breadcrumb">
                    <li><a href="/index">主页</a></li>
                    <li><a href="#">教务管理</a></li>
                    <li class="active">课程管理</li>
                </ol>
            </div>
            <div class="header" v-if="url.indexOf('course') !== -1 && url.indexOf('teach') === -1">
                <h1 class="page-header">
                    先锋教学系统
                    <small>新课程申请</small>
                </h1>
                <ol class="breadcrumb">
                    <li><a href="/index">主页</a></li>
                    <li><a href="#">教学系统</a></li>
                    <li class="active">新课程申请</li>
                </ol>
            </div>

            <div id="page-inner">

                <div class="row" v-show="pageMode === 'manage' && student">
                    <div class="col-md-12">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <span style="cursor: pointer" data-toggle="collapse" data-parent="#accordion"
                                      href="#collapseTwo" class="collapsed">课程中学生详情</span>
                            </div>
                            <div id="collapseTwo" class="panel-collapse">
                                <div class="panel-body">
                                    <div class="col-md-7 col-sm-4">
                                        <div class="panel panel-default">
                                            <div class="panel-body">
                                                <table style="width: 100%" id="studentTable"
                                                       class="table table-striped table-bordered table-hover"></table>
                                            </div>
                                        </div>
                                    </div>
                                    <form id="editTranscript" class="form-group" method="post"
                                          onsubmit="return false">
                                        <div id="transcript" class="col-md-5 col-sm-4">
                                            <div class="panel panel-info">
                                                <div class="panel-heading">
                                                    学生成绩详情
                                                </div>
                                                <div class="panel-body">
                                                    <div class="form-group">
                                                        <div class="col-sm-3">
                                                            <label for="sid"
                                                                   class="col-sm-12 control-label">学生ID:</label>
                                                        </div>
                                                        <div class="col-sm-9">
                                                            <input id="sid" value="" class="form-control"
                                                                   disabled>
                                                        </div>
                                                        <div class="col-sm-3" style="margin-top:10px;">
                                                            <label class="col-sm-12 control-label">*课程CRN:</label>
                                                        </div>
                                                        <div class="col-sm-9" style="margin-top:10px;">
                                                            <input class="form-control" required disabled
                                                                   v-model="transcript.crn"/>
                                                        </div>
                                                        <div class="col-sm-3" style="margin-top:10px;">
                                                            <label class="col-sm-12 control-label">*课程学分:</label>
                                                        </div>
                                                        <div class="col-sm-9" style="margin-top:10px;">
                                                            <input id="credits2" class="form-control"
                                                                   required v-model="transcript.credits"
                                                                   disabled/>
                                                        </div>
                                                        <div class="col-sm-3" style="margin-top:10px;">
                                                            <label class="col-sm-12 control-label">*成绩:</label>
                                                        </div>
                                                        <div class="col-sm-9" style="margin-top:10px;">
                                                            <input placeholder="可使用Letter Grade或百分制"
                                                                   id="grade"
                                                                   name="grade" value=""
                                                                   class="form-control" v-model="transcript.grade"
                                                                   minlength="1" required>
                                                        </div>

                                                        <div class="col-sm-3" style="margin-top:10px;">
                                                            <label class="col-sm-12 control-label">*完成情况:</label>
                                                        </div>
                                                        <div class="col-sm-9" style="margin-top:10px;">
                                                            <div class="radio3 radio-check radio-success radio-inline">
                                                                <input type="radio" id="complete" name="complete"
                                                                       value="1"
                                                                       v-model="transcript.complete">
                                                                <label for="complete">完成</label>
                                                            </div>
                                                            <div class="radio3 radio-check radio-success radio-inline">
                                                                <input type="radio" id="process" name="complete"
                                                                       value="0"
                                                                       v-model="transcript.complete">
                                                                <label for="process">正在进行</label>
                                                            </div>
                                                            <div class="radio3 radio-check radio-success radio-inline">
                                                                <input type="radio" id="nComplete" name="nComplete"
                                                                       value="-1"
                                                                       v-model="transcript.complete">
                                                                <label for="nComplete">未完成</label>
                                                            </div>

                                                        </div>
                                                    </div>
                                                    <div class="col-sm-3" style="margin-top:10px;">
                                                        <label for="tPassword"
                                                               class="col-sm-12 control-label">*管理员操作密码:</label>
                                                    </div>
                                                    <div class="col-sm-9" style="margin-top:10px;">
                                                        <input type="password" id="tPassword"
                                                               class="form-control" minlength="6"
                                                               maxlength="16" checkOpPwd="true" required/>
                                                    </div>
                                                    <div class="col-sm-6" style="margin-top:10px;">
                                                        <button class="btn btn-primary btn-success">更新
                                                        </button>
                                                    </div>
                                                    <div class="col-sm-6" style="margin-top:10px;">
                                                        <button class="btn btn-primary btn-danger">
                                                            取消
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="panel panel-default">
                            <div class="panel-heading">
                            <span style="cursor: pointer" data-toggle="collapse" data-parent="#accordion"
                                  href="#collapseThree" class="collapsed">添加学生</span>
                            </div>
                            <div id="collapseThree" class="panel-collapse collapse">
                                <div class="panel-body">
                                    <div class="col-md-8 col-sm-4">
                                        <table style="width:100%" id="userTable"
                                               class="table table-striped table-bordered table-hover"></table>
                                    </div>
                                    <div class="col-md-4 col-sm-4">
                                        <div id="assignSDiv" class="group-form-input">
                                            <h4 class="status" style="margin-top: 0px;">添加选项: </h4>
                                            <table style="font-size: 11px">
                                                <tr>
                                                    <td style="color: red;font-weight: 900;margin-bottom: -5px">
                                                        <input type="checkbox" name="pre"
                                                               style="height: 14px; font-size:15px; margin: 10px 4px 10px 0; width: 12px;">
                                                        添加此学生，即使未完成预选课程
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td style="color: red;font-weight: 900;">
                                                        <input type="checkbox" name="time"
                                                               style="height: 14px; font-size:15px;margin: 10px 4px 10px 0; width: 12px;">
                                                        添加此学生，即使有时间冲突
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td style="color: red;font-weight: 900;">
                                                        <input type="checkbox" name="capa"
                                                               style="height: 14px; font-size:15px;margin: 10px 4px 10px 0; width: 12px;">
                                                        添加此学生，即使已经达到课程人数上限
                                                    </td>
                                                </tr>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row" v-show="pageMode === 'manage' && table">
                    <div class="col-md-12">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                搜索条件
                            </div>
                            <div class="panel-body">
                                <div class="form-group">
                                    <div class="col-sm-2">
                                        <label class="col-sm-12 control-label">*按学期查询:</label>
                                    </div>
                                    <div class="col-sm-3">
                                        <select class="js-example-basic-single info col-sm-12"></select>
                                    </div>
                                    <div class="col-sm-2">
                                        <label class="col-sm-12 control-label">*按授课老师查询:</label>
                                    </div>
                                    <div class="col-sm-3">
                                        <select class="js-example-basic-single user col-sm-12"></select>
                                    </div>
                                    <div class="col-sm-2">
                                        <button class="btn btn-primary col-sm-12" onclick="refresh()">查询</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-12">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                课程列表
                            </div>
                            <div class="panel-body">
                                <table class="table table-striped table-bordered table-hover" id="courseTable"></table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row" v-show="pageMode === 'request' || pageMode === 'create' || detail">
                    <div class="col-md-12">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <button class="btn btn-primary btn-info" type="button"
                                        v-if="pageMode === 'create' && id !== ''"
                                        onclick="window.location.href=basePath + '/teach/request?mode=manage'">
                                    <i class="fa fa-arrow-left"></i> 返回列表
                                </button>
                                <button class="btn btn-primary btn-info" type="button"
                                        v-if="pageMode === 'request' && id !== ''"
                                        onclick="window.location.href=basePath + '/course/request?mode=faculty'">
                                    <i class="fa fa-arrow-left"></i> 返回列表
                                </button>
                                <button class="btn btn-primary btn-info" type="button"
                                        v-if="pageMode === 'manage'"
                                        v-on:click="showTable">
                                    <i class="fa fa-arrow-left"></i> 返回列表
                                </button>
                                课程基本信息表
                            </div>
                            <div class="panel-body">
                                <form class="form-horizontal">
                                    <div class="col-md-12 col-sm-4">
                                        <div class="panel panel-danger">
                                            <div class="panel-heading">
                                                学期信息
                                            </div>
                                            <div class="form-group panel-body">
                                                <div class="col-sm-2">
                                                    <label class="col-sm-12 control-label">*年份-学期(YYYY-XX):</label>
                                                </div>
                                                <div class="col-sm-3">
                                                    <input class="form-control" required v-model="course.info"
                                                           :disabled="tempCourse.status==='0'?false:true"/>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-12 col-sm-4">
                                        <div class="panel panel-primary">
                                            <div class="panel-heading">
                                                课程基本信息
                                            </div>
                                            <div class="panel-body">
                                                <div class="form-group">
                                                    <div class="col-sm-2">
                                                        <label class="col-sm-12 control-label">*课程名:</label>
                                                    </div>
                                                    <div class="col-sm-3">
                                                        <input class="form-control"
                                                               minlength="1"
                                                               maxlength="20"
                                                               required v-model="course.name"
                                                               :disabled="tempCourse.status==='0'?false:true"/>
                                                    </div>
                                                    <div class="col-sm-2">
                                                        <label class="col-sm-12 control-label">*课程等级:</label>
                                                    </div>
                                                    <div class="col-sm-3">
                                                        <input isDigits="true"
                                                               class="form-control"
                                                               placeholder="*100-499" minlength="3"
                                                               maxlength="3" required
                                                               v-model="course.level"
                                                               :disabled="tempCourse.status==='0'?false:true"/>
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <div class="col-sm-2">
                                                        <label class="col-sm-12 control-label">*课程班级:</label>
                                                    </div>
                                                    <div class="col-sm-3">
                                                        <input class="form-control"
                                                               placeholder="*01,02,03..."
                                                               minlength="2" maxlength="2" required
                                                               v-model="course.section"
                                                               :disabled="tempCourse.status==='0'?false:true"/>
                                                    </div>
                                                    <div class="col-sm-2">
                                                        <label class="col-sm-12 control-label">*学分:</label>
                                                    </div>
                                                    <div class="col-sm-3">
                                                        <input isDigits="true"
                                                               placeholder="*0-4"
                                                               class="form-control" minlength="1"
                                                               maxlength="1" required
                                                               v-model="course.credits"
                                                               :disabled="tempCourse.status==='0'?false:true"/>
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <div class="col-sm-2">
                                                        <label class="col-sm-12 control-label">*课程容量:</label>
                                                    </div>
                                                    <div class="col-sm-3">
                                                        <input isDigits="true"
                                                               class="form-control" required
                                                               v-model="course.capacity"
                                                               :disabled="tempCourse.status==='0'?false:true"/>
                                                    </div>
                                                    <div class="col-sm-2">
                                                        <label class="col-sm-12 control-label">教室:</label>
                                                    </div>
                                                    <div class="col-sm-3">
                                                        <input class="form-control"
                                                               maxlength="20"
                                                               v-model="course.classroom"
                                                               :disabled="tempCourse.status==='0'?false:true"/>
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <div class="col-sm-2">
                                                        <label for="startdate"
                                                               class="col-sm-12 control-label">*开始日期:</label>
                                                    </div>
                                                    <div class="col-sm-3">
                                                        <input id="startdate" class="form-control"
                                                               required v-model="course.startDate"
                                                               :disabled="tempCourse.status==='0'?false:true"/>
                                                    </div>
                                                    <div class="col-sm-2">
                                                        <label for="enddate"
                                                               class="col-sm-12 control-label">*结束日期:</label>
                                                    </div>
                                                    <div class="col-sm-3">
                                                        <input id="enddate" class="form-control"
                                                               required
                                                               v-model="course.endDate"
                                                               :disabled="tempCourse.status==='0'?false:true"/>
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <div class="col-sm-2">
                                                        <label for="starttime"
                                                               class="col-sm-12 control-label">*开始时间:</label>
                                                    </div>
                                                    <div class="col-sm-3">
                                                        <input id="starttime" class="form-control"
                                                               required v-model="course.startTime"
                                                               :disabled="tempCourse.status==='0'?false:true"/>
                                                    </div>
                                                    <div class="col-sm-2">
                                                        <label for="endtime"
                                                               class="col-sm-12 control-label">*结束时间:</label>
                                                    </div>
                                                    <div class="col-sm-3">
                                                        <input id="endtime" class="form-control"
                                                               required
                                                               v-model="course.endTime"
                                                               :disabled="tempCourse.status==='0'?false:true"/>
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <div class="col-sm-2">
                                                        <label class="col-sm-12 control-label">*选择上课日:</label>
                                                    </div>
                                                    <div class="col-sm-8">
                                                        <div class="checkbox3 checkbox-success checkbox-inline checkbox-check checkbox-round checkbox-light">
                                                            <input type="checkbox" value="m" id="m"
                                                                   name="day" v-model="courseDay"
                                                                   :disabled="tempCourse.status==='0'?false:true">
                                                            <label for="m">星期一</label>
                                                        </div>
                                                        <div class="checkbox3 checkbox-success checkbox-inline checkbox-check checkbox-round checkbox-light">
                                                            <input type="checkbox" value="t" id="t"
                                                                   name="day" v-model="courseDay"
                                                                   :disabled="tempCourse.status==='0'?false:true">
                                                            <label for="t">星期二</label>
                                                        </div>
                                                        <div class="checkbox3 checkbox-success checkbox-inline checkbox-check checkbox-round checkbox-light">
                                                            <input type="checkbox" value="w" id="w"
                                                                   name="day" v-model="courseDay"
                                                                   :disabled="tempCourse.status==='0'?false:true">
                                                            <label for="w">星期三</label>
                                                        </div>
                                                        <div class="checkbox3 checkbox-success checkbox-inline checkbox-check checkbox-round checkbox-light">
                                                            <input type="checkbox" value="tr" id="tr"
                                                                   name="day" v-model="courseDay"
                                                                   :disabled="tempCourse.status==='0'?false:true">
                                                            <label for="tr">星期四</label>
                                                        </div>
                                                        <div class="checkbox3 checkbox-success checkbox-inline checkbox-check checkbox-round checkbox-light">
                                                            <input type="checkbox" value="f" id="f"
                                                                   name="day" v-model="courseDay"
                                                                   :disabled="tempCourse.status==='0'?false:true">
                                                            <label for="f">星期五</label>
                                                        </div>
                                                        <div class="checkbox3 checkbox-success checkbox-inline checkbox-check checkbox-round checkbox-light">
                                                            <input type="checkbox" value="sa" id="sa"
                                                                   name="day" v-model="courseDay"
                                                                   :disabled="tempCourse.status==='0'?false:true">
                                                            <label for="sa">星期六</label>
                                                        </div>
                                                        <div class="checkbox3 checkbox-success checkbox-inline checkbox-check checkbox-round checkbox-light">
                                                            <input type="checkbox" value="s" id="s"
                                                                   name="day" v-model="courseDay"
                                                                   :disabled="tempCourse.status==='0'?false:true">
                                                            <label for="s">星期日</label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="panel-footer">
                                                注意：*为必填项，其余选填。
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-12 col-sm-4">
                                        <div class="panel panel-success">
                                            <div class="panel-heading"
                                                 v-if="pageMode === 'create' || pageMode === 'manage'">
                                                教师与预修课分配
                                            </div>
                                            <div class="panel-heading" v-if="pageMode === 'request'">
                                                预修课分配
                                            </div>
                                            <div class="panel-body">
                                                <div class="form-group"
                                                     v-if="pageMode === 'create' || pageMode === 'manage'">
                                                    <div class="col-sm-2">
                                                        <label class="col-sm-12 control-label">*分配教师:</label>
                                                    </div>
                                                    <div class="col-sm-8">
                                                        <select class="js-example-basic-single user"
                                                                name="teacher" style="width: 100%;"
                                                                :disabled="tempCourse.status==='0'?false:true">
                                                        </select>
                                                    </div>

                                                </div>
                                                <div class="form-group">
                                                    <div class="col-sm-2">
                                                        <label class="col-sm-12 control-label">预修课程（可多选，可不选）:</label>
                                                    </div>
                                                    <div class="col-sm-8">
                                                        <select class="col-sm-12 js-example-basic-multiple course"
                                                                name="preList[]" style="width: 100%;"
                                                                multiple="multiple"
                                                                :disabled="tempCourse.status==='0'?false:true">
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-12 col-sm-4">
                                        <div class="panel panel-default">
                                            <div class="panel-heading">
                                                更多信息
                                            </div>
                                            <div class="panel-body">
                                                <div class="form-group" v-if="!showDocument">
                                                    <div class="col-sm-2">
                                                        <label class="col-sm-12 control-label">上传课程大纲:</label>
                                                    </div>
                                                    <div class="col-sm-6">
                                                        <input type="file" id="document"
                                                               :disabled="tempCourse.status==='0'?false:true">
                                                    </div>
                                                </div>
                                                <div class="form-group" v-if="showDocument">
                                                    <div class="col-sm-2">
                                                        <label class="col-sm-12 control-label">课程大纲:</label>
                                                    </div>
                                                    <div class="col-sm-4" style="margin-top: 10px;">
                                                        下载文件： <a onclick="documentDownload()" style="cursor: pointer;"
                                                                 class="control-label">{{course.courseInfo.name}}</a>
                                                    </div>
                                                    <div class="col-sm-2">
                                                        <button style="width: 100%" class="btn btn-primary btn-danger"
                                                                v-on:click="showDocument = false">
                                                            替换
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <div class="col-sm-2">
                                                        <label class="col-sm-12 control-label">备注信息:</label>
                                                    </div>
                                                    <div class="col-sm-8">
                                                        <textarea style="resize: none;" class="form-control" rows="3"
                                                                  v-model="course.comment"
                                                                  :disabled="tempCourse.status==='0'?false:true"></textarea>
                                                    </div>
                                                </div>

                                                <div class="form-group">
                                                    <div class="col-sm-2">
                                                        <label class="col-sm-12 control-label">*请确认上述信息正确无误:</label>
                                                    </div>
                                                    <div class="col-sm-3">
                                                        <div class="checkbox3 checkbox-danger checkbox-inline checkbox-check checkbox-circle checkbox-light">
                                                            <input type="checkbox" id="yes"
                                                                   name="confirm"
                                                                   required
                                                                   :disabled="tempCourse.status==='0'?false:true">
                                                            <label for="yes">确认</label>
                                                        </div>
                                                    </div>
                                                    <div v-if="pageMode === 'create' || pageMode === 'manage'">
                                                        <div class="col-sm-2">
                                                            <label class="col-sm-12 control-label">*管理员操作密码:</label>
                                                        </div>
                                                        <div class="col-sm-3">
                                                            <input type="password"
                                                                   class="form-control" minlength="6"
                                                                   maxlength="16" checkOpPwd="true"
                                                                   :disabled="tempCourse.status==='0'?false:true"
                                                                   required/>
                                                        </div>
                                                    </div>
                                                    <button style="width:150px;" class="btn btn-primary"
                                                            v-if="pageMode === 'create' && id === ''"
                                                            v-on:click="create"
                                                            onclick="return false;">创建课程
                                                    </button>
                                                    <button style="width:150px;" class="btn btn-success"
                                                            v-if="pageMode === 'manage' && id === ''"
                                                            v-on:click="update"
                                                            onclick="return false;">修改课程
                                                    </button>
                                                    <button style="width:150px;" class="btn btn-success"
                                                            v-if="pageMode === 'create' && id !== ''"
                                                            v-on:click="approve"
                                                            :disabled="tempCourse.status==='0'?false:true"
                                                            onclick="return false;">批准申请
                                                    </button>
                                                    <button style="width:150px;" class="btn btn-danger"
                                                            v-if="pageMode === 'create' && id !== ''"
                                                            v-on:click="decline"
                                                            :disabled="tempCourse.status==='0'?false:true"
                                                            onclick="return false;">拒绝申请
                                                    </button>
                                                    <button style="width:150px;" class="btn btn-primary"
                                                            v-if="pageMode === 'request' && id === ''"
                                                            v-on:click="submit"
                                                            onclick="return false;">提交申请
                                                    </button>
                                                    <button style="width:150px;" class="btn btn-danger"
                                                            v-if="pageMode === 'request' && id !== ''"
                                                            v-on:click="updateRequest"
                                                            onclick="return false;">修改申请
                                                    </button>
                                                </div>
                                                <div class="panel-footer">
                                                    注意：操作密码不是登录密码
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- /. PAGE INNER  -->
        </div>
        <div class="panel-footer" id=footerPlaceholder">
            <div th:include="/common :: footer" id="copyright"></div>

        </div>
    </div>
    <!-- /. PAGE WRAPPER  -->
</div>
<!-- /. WRAPPER  -->
<div th:include="/common :: load_js(true, false, true)"></div>
<script>

    let courseVue = new Vue({
        el: '#coursePage',
        data: {
            courseList: [],
            course: {
                crn: "",
                info: "",
                name: "",
                credits: "",
                level: "",
                section: "",
                startDate: "",
                endDate: "",
                startTime: "",
                endTime: "",
                capacity: "",
                classroom: "",
                comment: "",
                day: "",
                precrn: "",
                facultyId: "",
                courseInfo: ""
            },
            tempCourse: {
                id: "",
                crn: "",
                status: '0',
                createTime: "",
                updateTime: "",
                operatorId: "",
                facultyId: "",
                courseJson: "",
            },
            transcript: {
                studentId: "",
                grade: "",
                crn: "",
                complete: "",
                credits: ""
            },
            courseDay: [],
            preList: [],
            table: true,
            detail: false,
            showDocument: false,
            student: false,
            pageMode: location.search.split("&")[0].split("=")[1],
            id: location.search.split("&")[1].split("=")[1],
            url: location.pathname
        },
        mounted: function () {

            if (isNotEmpty(this.id))
                initRequest(this.id);

            //执行一个laydate实例
            laydate.render({
                elem: '#startdate',
                theme: '#393D49',
                showBottom: false,
                done: (value) => {
                    this.course.startDate = value
                }
            });
            laydate.render({
                elem: '#enddate',
                theme: '#393D49',
                showBottom: false,
                done: (value) => {
                    this.course.endDate = value
                }
            });
            laydate.render({
                elem: '#starttime',
                theme: '#393D49',
                type: 'time',
                min: '06:00:00',
                max: '22:00:00',
                showBottom: ['clear', 'confirm'],
                done: (value) => {
                    this.course.startTime = value
                }
            });
            laydate.render({
                elem: '#endtime',
                theme: '#393D49',
                type: 'time',
                min: '06:00:00',
                max: '22:00:00',
                showBottom: ['clear', 'confirm'],
                done: (value) => {
                    this.course.endTime = value
                }
            });
        },
        methods: {
            prepare: function () {
                let day = "", precrn = "";
                this.preList = $(".course").val();

                if (isNotEmpty(this.courseDay))
                    for (let i = 0; i < this.courseDay.length; i++)
                        if (isNotEmpty(this.courseDay[i]))
                            day += this.courseDay[i] + "/";

                if (isNotEmpty(this.preList))
                    for (let i = 0; i < this.preList.length; i++)
                        if (isNotEmpty(this.preList[i]))
                            precrn += this.preList[i] + "/";

                this.course.day = day;
                this.course.precrn = precrn;
                this.course.facultyId = $(".user").val();

                if (isNotEmpty(this.course.courseInfo))
                    this.course.courseInfo = JSON.stringify(this.course.courseInfo);
            },
            submit: function () {
                this.prepare();

                axios.post('/request/course/register', this.course).then(function (response) {
                    if (response.data.code === 2001) {
                        let id = response.data.data.id;
                        Showbo.Msg.alert("申请成功，等待教务答复!", function () {
                            documentUpload(id);
                            window.location.href = basePath + '/course/request?mode=faculty';
                        });
                    }
                    else
                        Showbo.Msg.alert(response.data.msg, function () {
                        });
                })
            },

            updateRequest: function () {
                this.prepare();

                this.tempCourse.courseJson = JSON.stringify(this.course);

                axios.put('/request/course/' + this.id, this.tempCourse).then(function (response) {
                    if (response.data.code === 2001)
                        Showbo.Msg.alert("修改成功，等待教务答复!", function () {
                            documentUpload();
                            window.location.href = basePath + '/course/request?mode=faculty';
                        });
                    else
                        Showbo.Msg.alert(response.data.msg, function () {
                        });
                })
            },

            create: function () {
                this.prepare();

                axios.post('/course', this.course).then(function (response) {
                    if (response.data.code === 2001)
                        Showbo.Msg.alert("创建成功!", function () {
                            courseVue.$data.course = response.data.data;
                            documentUpload(response.data.data.course.crn);
                            window.location.href = basePath + '/teach/course?mode=manage&id=';
                        });
                    else
                        Showbo.Msg.alert(response.data.msg, function () {
                        });
                })
            },
            update: function () {
                this.prepare();
                axios.put('/course/' + this.course.crn, this.course).then(function (response) {
                    if (response.data.code === 2001)
                        Showbo.Msg.alert("修改成功!", function () {
                            documentUpload();
                            window.location.reload();
                        });
                    else
                        Showbo.Msg.alert(response.data.msg, function () {
                        });
                })
            },
            showTable: function () {
                this.table = true;
                this.detail = false;
                this.student = false;
            },
            approve: function () {
                this.prepare();

                this.tempCourse.status = "1";
                this.tempCourse.courseJson = JSON.stringify(this.course);

                if (!this.showDocument)
                    documentUpload(this.id);
                update(this.id, this.tempCourse);

            },
            decline: function () {
                if (isNotEmpty(this.course.comment)) {
                    this.tempCourse.status = "-1";
                    this.tempCourse.courseJson = JSON.stringify(this.course);
                    update(this.id, this.tempCourse);
                } else
                    Showbo.Msg.alert("必须填写备注！", function () {
                    });

            }
        }
    });

    function update(id, tempCourse) {
        axios.put("/request/course/" + id, tempCourse).then(function (response) {
            if (response.data.code === 2001)
                Showbo.Msg.alert(response.data.msg, function () {
                    window.location.href = "/teach/request?mode=manage"
                });
            else
                Showbo.Msg.alert(response.data.msg, function () {
                });
        });
    }

    function initCourse() {
        courseVue.$data.courseDay = courseVue.$data.course.day.split("/");
        courseVue.$data.preList = courseVue.$data.course.precrn.split("/");

        if (isNotEmpty(courseVue.$data.course.courseInfo)) {
            courseVue.$data.course.courseInfo = JSON.parse(courseVue.$data.course.courseInfo);
            courseVue.$data.showDocument = true;
        }

        let preListOption = [];
        for (let i = 0; i < courseVue.$data.preList.length; i++)
            if (courseVue.$data.preList[i] !== "")
                preListOption.push(new Option(courseVue.$data.preList[i], courseVue.$data.preList[i], true, true));
        courseSelect.append(preListOption);
        courseSelect.trigger('change');

        let facultyId = courseVue.$data.course.facultyId;
        userSelect.append(new Option(facultyId, facultyId, true, true));
        courseSelect.trigger('change');

    }

    function initRequest(id) {
        if (isNotEmpty(id)) {
            axios.get('/request/course/' + id).then(function (response) {
                courseVue.$data.tempCourse = response.data.data;
                courseVue.$data.course = JSON.parse(response.data.data.courseJson);
                courseVue.$data.course.facultyId = response.data.data.facultyId;
                initCourse();
            });
        }
    }

    function showCourseDetail(crn) {
        if (isNotEmpty(crn)) {
            axios.get('/course/' + crn).then(function (response) {
                courseVue.$data.course = response.data.data;
                initCourse();
                courseVue.$data.table = false;
                courseVue.$data.detail = true;
            });
        }
    }

    function deleteCourse(crn) {
        Showbo.Msg.confirm("确认删除该课程？", function () {
            if ($(".btnfocus").val() !== "取消") {
                axios.delete('/course/' + crn).then(function (response) {
                    if (response.data.code === 2001)
                        Showbo.Msg.alert("删除成功!", function () {
                            courseTable.draw();
                        });
                    else
                        Showbo.Msg.alert(response.data.msg, function () {
                        });
                });
            }
        });
    }

    function documentUpload(key) {
        if (courseVue.$data.showDocument)
            return;

        if (!isNotEmpty(document.getElementById("document").files))
            return;

        let requestUrl = "/request/course/info/";
        let updateUrl = "/course/info/";
        let formData = new FormData();

        formData.append("file", document.getElementById("document").files[0]);
        let url;

        if (courseVue.$data.url.indexOf('course') !== -1 && courseVue.$data.pageMode !== 'manage') {
            if (isNotEmpty(key))
                url = requestUrl + key;
            else
                url = requestUrl + courseVue.$data.id;
        } else {
            if (isNotEmpty(key))
                url = updateUrl + key;
            else
                url = updateUrl + courseVue.$data.course.crn;
        }

        axios.put(url, formData).then(function (response) {
            if (response.data.code === 2001) {
                courseVue.$data.course.courseInfo = response.data.data;
                courseVue.$data.showDocument = true;
            } else {
                Showbo.Msg.alert(response.data.msg, function () {
                });
            }
        });
    }

    function refresh() {
        courseTable.draw();
    }

    function documentDownload() {
        if (isNotEmpty(courseVue.$data.id))//申请中的下载
            window.open(basePath + "/request/course/info/" + courseVue.$data.id);
        else {//查看下载
            window.open(basePath + "/course/info/" + courseVue.$data.course.crn);
        }
    }

    //教师select
    let userSelect = $(".user").select2({
        ajax: {
            url: basePath + "/user/search",
            type: "GET",
            delay: 250,
            data: function (params) {
                return {
                    search: params.term, // search term 请求参数 ， 请求框中输入的参数
                    status: "1",
                    type: "f"
                };
            },
            processResults: function (data, params) {
                let itemList = [];
                let item;
                for (let i = 0; i < data.data.length; i++) {
                    item = {
                        id: data.data[i].userId,
                        text: data.data[i].lastName + ", " + data.data[i].firstName
                    };
                    itemList.push(item);
                }
                return {
                    results: itemList//itemList
                };
            },
            cache: true
        },
        placeholder: '请分配所属集群',//默认文字提示
        language: "zh-CN",
        tags: false,//允许手动添加
        allowClear: true,//允许清空
        escapeMarkup: function (markup) {
            return markup;
        }, // 自定义格式化防止xss注入
        minimumInputLength: 0,//最少输入多少个字符后开始查询
        templateResult: formatRepo,
        templateSelection: formatRepoSelection
    });

    //课程select
    let courseSelect = $('.course').select2({
        ajax: {
            url: basePath + "/course/search",
            type: "GET",
            delay: 250,
            data: function (params) {
                return {
                    search: params.term
                };
            },
            processResults: function (data, params) {
                let itemList = [];
                let item;
                for (let i = 0; i < data.data.length; i++) {
                    item = {
                        id: data.data[i].crn,
                        text: data.data[i].name
                    };
                    itemList.push(item);
                }
                return {
                    results: itemList
                };
            },
            cache: true
        },
        language: "zh-CN",
        tags: false,//允许手动添加
        allowClear: true,//允许清空
        escapeMarkup: function (markup) {
            return markup;
        }, // 自定义格式化防止xss注入
        minimumInputLength: 0,//最少输入多少个字符后开始查询
        templateResult: formatRepo,
        templateSelection: formatRepoSelection
    });

    $(".info").select2({
        ajax: {
            url: basePath + "/course/info",
            type: "GET",
            delay: 250,
            data: function (params) {
                return {
                    search: params.term,
                };
            },
            processResults: function (data) {
                let itemList = [];
                let item;
                for (let i = 0; i < data.data.length; i++) {
                    item = {
                        id: data.data[i],
                        text: data.data[i]
                    };
                    itemList.push(item);
                }
                item = {
                    id: "",
                    text: "清除"
                };
                itemList.push(item);
                return {
                    results: itemList
                };
            },
            cache: true
        },
        language: "zh-CN",
        tags: false,//允许手动添加
        allowClear: true,//允许清空
        escapeMarkup: function (markup) {
            return markup;
        }, // 自定义格式化防止xss注入
        minimumInputLength: 0,
        templateResult: formatRepo,
        templateSelection: formatRepoSelection
    });

    let courseTable = $("#courseTable").DataTable({

        "language": {
            "aria": {
                "sortAscending": ": activate to sort column ascending",
                "sortDescending": ": activate to sort column descending"
            },
            "emptyTable": "没有数据！",
            "info": "显示 _START_ 至 _END_ 条 ，总共_TOTAL_ 条数据",
            "infoEmpty": "没有发现记录！",
            "infoFiltered": "(从_MAX_条记录中搜索)",
            "lengthMenu": "显示: _MENU_",
            "search": "模糊搜索:",
            "zeroRecords": "没有找到匹配的记录！",
            "paginate": {
                "previous": "上一页",
                "next": "下一页",
                "last": "尾页",
                "first": "首页"
            }
        },
        "pagingType": "full_numbers",
        "lengthMenu": [
            [5, 10, 15, 20],
            [5, 10, 15, 20]
        ],
        pageLength: 10,
        processing: true,
        serverSide: true,

        ajax: {
            url: basePath + "/course",
            data: function (d) {
                d.info = $(".info").val();
                d.facultyId = $(".user").val();
            }
        },
        columns: [
            {
                "data": null, "title": "行号", "render": function (data, type, row, meta) {
                    return meta.settings._iDisplayStart + meta.row + 1;
                }
            },
            {"data": "crn", "title": "编号"},
            {
                "data": null, "title": "课程名（等级-班级）", "createdCell": function (nTd, rowData) {
                    $(nTd).html('<p style="line-height: 1.42857143; padding-top: 0; color:blue; ">' + rowData.name + '<br/>' + "(" + rowData.level + "-" + rowData.section + ")" + '</p>');
                }
            },
            {"data": "capacity", "title": "容量"},
            {"data": "remain", "title": "剩余"},
            {
                "data": "status", "title": "状态", "createdCell": function (nTd, rowData) {
                    if (rowData === 1)
                        $(nTd).html('<p style="line-height: 1.42857143; padding-top: 0; color:blue; ">未开始</p>');
                    else if (rowData === 0)
                        $(nTd).html('<p style="line-height: 1.42857143; padding-top: 0; color:green; ">进行中</p>');
                    else if (rowData === -1)
                        $(nTd).html('<p style="line-height: 1.42857143; padding-top: 0; color:red; ">已结课</p>');

                }
            },
            {"data": "date", "title": "起止时间"},
            {"data": "time", "title": "上课时间"},
            {"data": "day", "title": "星期"},
            {"data": "faculty", "title": "授课老师"},
            {
                "data": null, "title": "操作", "createdCell": function (nTd, rowData) {
                    $(nTd).html(
                        '<a style="cursor: pointer" onclick="showCourseDetail(\'' + rowData.crn + '\')"><i class="fa fa-search"></i>查看并编辑</a><br/>' +
                        '<a style="cursor: pointer; color: darkred" onclick="deleteCourse(\'' + rowData.crn + '\')"><i class="fa fa-trash"></i>删除该课程</a><br/>' +
                        '<a style="cursor: pointer; color: green" onclick="showStudentDetail(\'' + rowData.crn + '\',\'' + rowData.credits + '\')"><i class="fa fa-user"></i>课程学生信息</a>'
                    );
                    $(nTd).css({textAlign: "left"})
                }, "width": "100px"
            }
        ],
        "columnDefs": [{
            orderable: false,
            targets: [9]
        }, {
            "defaultContent": "",
            "targets": "_all"
        }]
    });

    let studentTable;

    function showStudentDetail(crn, credits) {
        courseVue.$data.transcript.crn = crn;
        courseVue.$data.transcript.credits = credits;
        courseVue.$data.table = false;
        courseVue.$data.detail = false;
        courseVue.$data.student = true;

        studentTable = $("#studentTable").DataTable({

            "language": {
                "aria": {
                    "sortAscending": ": activate to sort column ascending",
                    "sortDescending": ": activate to sort column descending"
                },
                "emptyTable": "没有数据！",
                "info": "显示 _START_ 至 _END_ 条 ，总共_TOTAL_ 条数据",
                "infoEmpty": "没有发现记录！",
                "infoFiltered": "(从_MAX_条记录中搜索)",
                "lengthMenu": "显示: _MENU_",
                "search": "搜索:",
                "zeroRecords": "没有找到匹配的记录！",
                "paginate": {
                    "previous": "上一页",
                    "next": "下一页",
                    "last": "尾页",
                    "first": "首页"
                }
            },
            "pagingType": "full_numbers",
            "lengthMenu": [
                [5, 10, 15],
                [5, 10, 15]
            ],
            pageLength: 5,
            processing: true,
            serverSide: true,

            ajax: {
                url: basePath + "/transcript/" + courseVue.$data.transcript.crn + "/student",
            },
            columns: [
                {"data": "studentId", "title": "学生ID"},
                {"data": "sname", "title": "学生名"},
                {"data": "grade", "title": "学生成绩"},
                {
                    "data": "complete", "title": "完成情况", "createdCell": function (nTd, rowData) {
                        if (rowData === "1")
                            $(nTd).html('<p style="line-height: 1.42857143; padding-top: 0; color:green; ">完成</p>');
                        else if (rowData === "0")
                            $(nTd).html('<p style="line-height: 1.42857143; padding-top: 0; color:blue; ">进行中</p>');
                        else if (rowData === "-1")
                            $(nTd).html('<p style="line-height: 1.42857143; padding-top: 0; color:red; ">挂科</p>');
                    }
                },
                {
                    "data": null, "title": "操作", "createdCell": function (nTd) {
                        $(nTd).html('<button style="width: 50%" class="btn btn-success">修改成绩</button>' +
                            '<button style="width: 50%" class="btn btn-danger">移除</button>');
                    }, "width": "200px"
                }
            ],
            "columnDefs": [{
                orderable: false,
                targets: [4]
            }, {
                "defaultContent": "",
                "targets": "_all"
            }]
        });

    }

    let userTable = $("#userTable").DataTable({
        "language": {
            "aria": {
                "sortAscending": ": activate to sort column ascending",
                "sortDescending": ": activate to sort column descending"
            },
            "emptyTable": "没有数据！",
            "info": "显示 _START_ 至 _END_ 条 ，总共_TOTAL_ 条数据",
            "infoEmpty": "没有发现记录！",
            "infoFiltered": "(从_MAX_条记录中搜索)",
            "lengthMenu": "显示: _MENU_",
            "search": "搜索:",
            "zeroRecords": "没有找到匹配的记录！",
            "paginate": {
                "previous": "上一页",
                "next": "下一页",
                "last": "尾页",
                "first": "首页"
            }
        },
        "pagingType": "full_numbers",
        "lengthMenu": [
            [5],
            [5]
        ],
        pageLength: 5,
        processing: true,
        serverSide: true,

        ajax: {
            url: basePath + "/student",
            data: function (d) {
                d.status = "1";
            }
        },
        columns: [
            {"data": "studentId", "title": "学生ID"},
            {"data": "sname", "title": "姓名"},
            {"data": "maxCredits", "title": "学分上限"},
            {"data": "complete", "title": "已完成"},
            {"data": "progress", "title": "进行中"},
            {"data": "incomplete", "title": "未完成"},
            {
                "data": null, "title": "操作", "createdCell": function (nTd) {
                    $(nTd).html('<button style="width: 100%" class="btn btn-info">添加</button>');
                }, "width": "100px"
            }
        ],
        "columnDefs": [{
            orderable: false,
            targets: [6]
        }, {
            "defaultContent": "",
            "targets": "_all"
        }]
    });
</script>
</body>
</html>
